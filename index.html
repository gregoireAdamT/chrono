<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronom√©trage Aquathlon XS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        /* Onglets */
        .tabs-container {
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            gap: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chrono-section-single {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .chrono-card-full {
            width: 100%;
            max-width: 600px;
            background: linear-gradient(135deg, #ff9a8b 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .chrono-card-full h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 2em;
        }

        .time-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group-large {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        .input-group-large input {
            flex: 2;
            padding: 20px;
            font-size: 18px;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
        }

        .input-group-large input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .btn-large {
            flex: 1;
            padding: 20px 30px;
            font-size: 18px;
            min-height: 60px;
        }

        .controls {
            margin-bottom: 30px;
        }

        .controls input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .next-start {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            color: #333;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }

        .instructions p {
            margin-bottom: 8px;
            color: #333;
        }

        .instructions kbd {
            background: #333;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .records-section {
            margin-top: 40px;
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .records-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .export-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .records-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-depart {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-arrivee {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .edit-btn {
            background: #ffc107;
            color: #333;
            padding: 4px 8px;
            font-size: 12px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .chrono-section {
                flex-direction: column;
            }
            
            .chrono-card {
                min-width: auto;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .time-display {
                font-size: 1.5em;
            }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Mini tableaux pour chaque onglet */
        .mini-records {
            margin-top: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .mini-records h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .mini-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .mini-table table {
            width: 100%;
            font-size: 14px;
        }

        .mini-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            padding: 10px;
        }

        .mini-table td {
            padding: 8px 10px;
        }

        .mini-table .edit-btn, 
        .mini-table .delete-btn {
            padding: 2px 6px;
            font-size: 11px;
        }

        /* Styles pour la section de sauvegarde */
        .backup-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
        }

        .backup-section h3, .backup-section h4 {
            margin-bottom: 15px;
            color: white;
        }

        .backup-config {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .backup-status-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .backup-status {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 200px;
        }

        .backup-status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .backup-status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .backup-status.cloud {
            background: rgba(0, 150, 255, 0.2);
            border: 1px solid rgba(0, 150, 255, 0.3);
        }

        .google-sheets-config {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .config-inputs {
            margin-bottom: 15px;
        }

        .config-inputs input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .config-inputs small {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Styles pour les m√©thodes de synchronisation */
        .sync-methods {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sync-method {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sync-method h5 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-method small {
            display: block;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .file-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .google-sheet-instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .google-sheet-instructions h5 {
            margin-bottom: 10px;
            color: white;
        }

        .google-sheet-instructions ol {
            color: rgba(255, 255, 255, 0.9);
            padding-left: 20px;
        }

        .google-sheet-instructions ol li {
            margin-bottom: 5px;
        }

        .alternative-services {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .alternative-services .btn {
            flex: 1;
            min-width: 100px;
            font-size: 12px;
            padding: 8px 12px;
        }

        .failover-status {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .cors-warning {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .cors-warning p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }

        .cors-solutions {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .cors-solutions .btn {
            flex: 1;
            min-width: 120px;
            font-size: 12px;
        }

        /* Indicateur de statut de connexion */
        .connection-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .connection-status.online {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .connection-status.offline {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        #connection-indicator {
            font-size: 1.2em;
            font-weight: bold;
        }

        #connection-details {
            display: block;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèä‚Äç‚ôÇÔ∏è Chronom√©trage Aquathlon XS üèÉ‚Äç‚ôÄÔ∏è</h1>
        
        <div id="alert-container"></div>
        
        <!-- Statut de connexion -->
        <div class="connection-status" id="connection-status">
            <span id="connection-indicator">üåê Chargement...</span>
            <small id="connection-details">V√©rification de la connexion...</small>
        </div>
        
        <!-- Onglets de navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('start')">üèä‚Äç‚ôÇÔ∏è D√âPARTS</button>
                <button class="tab-btn" onclick="switchTab('finish')">üèÅ ARRIV√âES</button>
                <button class="tab-btn" onclick="switchTab('records')">üìä RECORDS</button>
            </div>
        </div>
        
        <!-- Onglet D√©parts -->
        <div id="start-tab" class="tab-content active">
            <div class="chrono-section-single">
                <div class="chrono-card-full">
                    <h2>üèä‚Äç‚ôÇÔ∏è D√âPARTS PISCINE</h2>
                    <div class="time-display" id="startTime">--:--:--</div>
                    <div class="input-group-large">
                        <input type="number" id="startDossard" placeholder="N¬∞ de dossard" min="1">
                        <button class="btn btn-primary btn-large" onclick="enregistrerDepart()">D√âPART ‚è±Ô∏è</button>
                    </div>
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="preparerProchainDepart()">‚è∞ Pr√©parer d√©part +30s</button>
                        <div class="next-start" id="nextStartInfo" style="display: none;">
                            <strong>Prochain d√©part pr√©vu :</strong> <span id="nextStartTime"></span>
                        </div>
                    </div>
                    <div class="instructions">
                        <p><strong>üí° Instructions :</strong></p>
                        <p>‚Ä¢ Saisissez le n¬∞ de dossard puis appuyez sur <kbd>Entr√©e</kbd></p>
                        <p>‚Ä¢ Ou cliquez directement "D√âPART" puis saisissez le n¬∞ apr√®s</p>
                    </div>
                </div>
            </div>
            
            <!-- Mini tableau des d√©parts r√©cents -->
            <div class="mini-records">
                <h3>üïê Derniers d√©parts</h3>
                <div class="mini-table">
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∞ Dossard</th>
                                <th>Heure</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="startRecordsTable">
                            <!-- Les derniers d√©parts appara√Ætront ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Onglet Arriv√©es -->
        <div id="finish-tab" class="tab-content">
            <div class="chrono-section-single">
                <div class="chrono-card-full">
                    <h2>üèÅ ARRIV√âES</h2>
                    <div class="time-display" id="finishTime">--:--:--</div>
                    <div class="input-group-large">
                        <input type="number" id="finishDossard" placeholder="N¬∞ de dossard" min="1">
                        <button class="btn btn-primary btn-large" onclick="enregistrerArrivee()">ARRIV√âE üèÅ</button>
                    </div>
                    <div class="controls">
                        <input type="text" id="tempsManuel" placeholder="HH:MM:SS (saisie manuelle optionnelle)">
                        <small>Laissez vide pour capturer l'heure actuelle automatiquement</small>
                    </div>
                    <div class="instructions">
                        <p><strong>üí° Instructions :</strong></p>
                        <p>‚Ä¢ Appuyez sur <kbd>Entr√©e</kbd> pour capturer l'arriv√©e instantan√©ment</p>
                        <p>‚Ä¢ Le n¬∞ de dossard peut √™tre saisi avant ou apr√®s</p>
                        <p>‚Ä¢ Pour corriger l'heure, utilisez le champ de saisie manuelle</p>
                    </div>
                </div>
            </div>
            
            <!-- Mini tableau des arriv√©es r√©centes -->
            <div class="mini-records">
                <h3>üèÅ Derni√®res arriv√©es</h3>
                <div class="mini-table">
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∞ Dossard</th>
                                <th>Heure</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="finishRecordsTable">
                            <!-- Les derni√®res arriv√©es appara√Ætront ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Onglet Records -->
        <div id="records-tab" class="tab-content">
            <!-- Section de configuration de sauvegarde -->
            <div class="backup-section">
                <h3>üõ°Ô∏è Configuration de Sauvegarde</h3>
                <div class="backup-config">
                    <div class="backup-status-area">
                        <div id="backup-status" class="backup-status">Aucune sauvegarde effectu√©e</div>
                        <button class="btn btn-secondary" onclick="restaurerSauvegarde()">üì• Restaurer</button>
                        <button class="btn btn-secondary" onclick="exporterSauvegardeAuto()">üíæ Export Backup</button>
                    </div>
                    
                    <div class="google-sheets-config">
                        <h4>‚òÅÔ∏è Synchronisation entre Chronom√©treurs</h4>
                        
                        <div class="sync-methods">
                            <div class="sync-method">
                                <h5>‚ö° Syst√®me Hybride Recommand√©</h5>
                                <div class="config-inputs">
                                    <input type="url" id="webhook-url" placeholder="URL de webhook (Apps Script ou autre)" 
                                           onchange="configurerWebhook()">
                                    <button class="btn btn-secondary" onclick="testerWebhook()">üîó Tester</button>
                                </div>
                                <div class="failover-status" id="failover-status">
                                    <small>üõ°Ô∏è <strong>Triple s√©curit√© :</strong> Webhook ‚Üí Export auto ‚Üí CSV de secours</small>
                                </div>
                            </div>
                            
                            <div class="sync-method">
                                <h5>üìã M√©thode Simple : Copier-Coller</h5>
                                <button class="btn export-btn" onclick="exporterCSVPourSheets()">üìã Copier CSV</button>
                                <small>Copiez les donn√©es puis collez dans Google Sheets (Ctrl+V)</small>
                            </div>
                            
                            <div class="sync-method">
                                <h5>üìÅ Import/Export Fichiers</h5>
                                <div class="file-buttons">
                                    <button class="btn btn-secondary" onclick="exporterSauvegardeAuto()">üì• T√©l√©charger JSON</button>
                                    <input type="file" id="csv-import" accept=".csv" style="display: none;" onchange="handleFileImport(event)">
                                    <button class="btn btn-secondary" onclick="document.getElementById('csv-import').click()">üì§ Importer CSV</button>
                                </div>
                                <small>Partagez les fichiers entre les deux postes</small>
                            </div>
                            
                            
                            <div class="sync-method">
                                <h5>üîó Alternatives sans Quotas</h5>
                                <div class="alternative-services">
                                    <button class="btn btn-secondary" onclick="window.open('https://webhook.site', '_blank')">üåê Webhook.site</button>
                                    <button class="btn btn-secondary" onclick="window.open('https://pipedream.com', '_blank')">‚ö° Pipedream</button>
                                    <button class="btn btn-secondary" onclick="window.open('https://n8n.cloud', '_blank')">üîÑ n8n</button>
                                </div>
                                <small>Services webhook sans limitations pour usage intensif</small>
                            </div>
                            
                            <div class="sync-method">
                                <h5>üîó Webhook Apps Script (Limit√©)</h5>
                                <div class="config-inputs">
                                    <input type="url" id="webhook-url-legacy" placeholder="URL Apps Script (20K requ√™tes/jour max)" 
                                           onchange="configurerWebhookLegacy()">
                                    <button class="btn btn-secondary" onclick="creerAppsScript()">‚ûï Cr√©er Script</button>
                                </div>
                                <small>‚ö†Ô∏è Limit√© √† 20,000 requ√™tes/jour - OK pour un Aquathlon</small>
                            </div>
                        </div>
                        
                        <div class="google-sheet-instructions">
                            <h5>üí° Instructions Google Sheets :</h5>
                            <ol>
                                <li>Cr√©ez un <a href="https://docs.google.com/spreadsheets/create" target="_blank">nouveau Google Sheet</a></li>
                                <li>Partagez-le avec l'autre chronom√©treur</li>
                                <li>Utilisez "Copier CSV" puis Ctrl+V dans le Sheet</li>
                                <li>Rafra√Æchissez r√©guli√®rement pour voir les mises √† jour</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        
        <div class="records-section">
            <div class="records-header">
                <h2>üìä Enregistrements</h2>
                <div>
                    <button class="btn export-btn" onclick="exporterCSV()">üì• Exporter CSV</button>
                    <button class="btn btn-secondary" onclick="viderDonnees()">üóëÔ∏è Vider</button>
                </div>
            </div>
            
            <div class="records-table">
                <table>
                    <thead>
                        <tr>
                            <th>N¬∞ Dossard</th>
                            <th>Type</th>
                            <th>Heure</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable">
                        <!-- Les enregistrements appara√Ætront ici -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let records = [];
        let prochainDepartPrevu = null;
        let autoSaveEnabled = true;
        let lastBackupTime = null;

        // Configuration de sauvegarde
        const BACKUP_CONFIG = {
            localInterval: 5000,        // Sauvegarde locale toutes les 5 secondes
            googleSheetsInterval: 15000, // Sync Google Sheets toutes les 15 secondes
            maxLocalBackups: 50,        // Garder 50 sauvegardes locales maximum
        };

        // === SYST√àME DE SAUVEGARDE LOCAL ===
        
        // Sauvegarde automatique locale (navigateur)
        function sauvegardeLocale() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    records: records,
                    version: '1.0'
                };
                
                // Sauvegarde principale
                const backupKey = 'aquathlon_backup_' + Date.now();
                localStorage.setItem('aquathlon_current', JSON.stringify(backupData));
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Limiter le nombre de sauvegardes
                cleanOldBackups();
                
                lastBackupTime = new Date();
                updateBackupStatus(`‚úÖ Sauv√© localement √† ${lastBackupTime.toLocaleTimeString()}`);
                
            } catch (error) {
                console.error('Erreur sauvegarde locale:', error);
                updateBackupStatus('‚ùå Erreur sauvegarde locale');
            }
        }
        
        // Nettoyer les anciennes sauvegardes
        function cleanOldBackups() {
            const keys = Object.keys(localStorage);
            const backupKeys = keys.filter(key => key.startsWith('aquathlon_backup_'))
                                   .sort()
                                   .slice(0, -BACKUP_CONFIG.maxLocalBackups);
            
            backupKeys.forEach(key => localStorage.removeItem(key));
        }
        
        // Restaurer depuis la sauvegarde locale
        function restaurerSauvegarde() {
            try {
                const savedData = localStorage.getItem('aquathlon_current');
                if (savedData) {
                    const backup = JSON.parse(savedData);
                    if (backup.records && Array.isArray(backup.records)) {
                        records = backup.records;
                        updateAllTables();
                        showAlert(`‚úÖ ${records.length} enregistrements restaur√©s depuis la sauvegarde locale`, 'success', 3000);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Erreur lors de la restauration:', error);
                showAlert('‚ùå Erreur lors de la restauration', 'warning', 3000);
                return false;
            }
        }

        // === SYNCHRONISATION MULTI-NIVEAU ANTI-CORS ===
        
        let webhook_url = '';
        let sync_enabled = false;
        let failover_methods = {
            webhook: false,
            file_sync: false,
            manual_csv: false
        };
        
        // Configuration robuste avec failover
        const SYNC_CONFIG = {
            webhook_timeout: 5000,      // 5s timeout pour webhook
            retry_attempts: 3,          // 3 tentatives
            fallback_interval: 30000,   // Fallback toutes les 30s
            batch_size: 10             // Traiter par lots de 10
        };

        // M√âTHODE 1: POST avec form-data (√©vite preflight CORS)
        async function sendToWebhookNoCORS(data) {
            try {
                console.log('=== POST FORM-DATA ===');
                const formData = new URLSearchParams();
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(webhook_url, {
                    method: 'POST',
                    body: formData  // form-encoded, pas JSON
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('POST form-data success:', result);
                    return true;
                } else {
                    console.error('POST form-data HTTP error:', response.status);
                    return false;
                }
                
            } catch (error) {
                console.error('POST form-data error:', error);
                return false;
            }
        }
        
        // M√âTHODE 2: GET avec param√®tres (pas de preflight)
        async function sendToWebhookViaGET(data) {
            try {
                console.log('=== GET PARAMS ===');
                const params = new URLSearchParams({
                    data: JSON.stringify(data),
                    action: 'add_records'
                });
                
                const response = await fetch(`${webhook_url}?${params.toString()}`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('GET success:', result);
                    return true;
                } else {
                    console.error('GET HTTP error:', response.status);
                    return false;
                }
                
            } catch (error) {
                console.error('GET error:', error);
                return false;
            }
        }
        
        // M√âTHODE 3: Image tracking (0% CORS)
        function sendViaImageTracking(data) {
            return new Promise((resolve, reject) => {
                console.log('=== IMAGE TRACKING ===');
                const img = new Image();
                const params = new URLSearchParams({
                    data: JSON.stringify(data),
                    method: 'image'
                });
                
                let timeout = setTimeout(() => {
                    console.log('Image tracking timeout (mais peut avoir fonctionn√©)');
                    resolve(true); // On consid√®re que √ßa a march√© m√™me en timeout
                }, 10000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    console.log('Image tracking success (onload)');
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    console.log('Image tracking "error" (mais peut avoir fonctionn√© c√¥t√© serveur)');
                    resolve(true); // M√™me en cas d'erreur, les donn√©es peuvent √™tre pass√©es
                };
                
                img.src = `${webhook_url}?${params.toString()}&t=${Date.now()}`;
                console.log('Image tracking URL:', img.src);
            });
        }

        // REMPLACER COMPL√àTEMENT l'ancienne fonction syncViaWebhook
        async function syncViaWebhook() {
            if (!webhook_url || records.length === 0) return false;
            
            console.log('=== SYNC ANTI-CORS ===');
            
            try {
                const data = {
                    timestamp: new Date().toISOString(),
                    records: records,
                    source: 'aquathlon_chrono',
                    total: records.length
                };
                
                console.log('Tentative sync avec', records.length, 'records');
                
                // M√âTHODE 1: POST form-data
                console.log('Essai POST form-data...');
                const success1 = await sendToWebhookNoCORS(data);
                if (success1) {
                    updateBackupStatus(`‚òÅÔ∏è Sync POST form-data r√©ussie (${records.length} records)`);
                    return true;
                }
                
                // M√âTHODE 2: GET params
                console.log('Essai GET params...');
                const success2 = await sendToWebhookViaGET(data);
                if (success2) {
                    updateBackupStatus(`‚òÅÔ∏è Sync GET r√©ussie (${records.length} records)`);
                    return true;
                }
                
                // M√âTHODE 3: Image tracking
                console.log('Essai image tracking...');
                await sendViaImageTracking(data);
                updateBackupStatus(`‚òÅÔ∏è Sync image tracking tent√©e (${records.length} records)`);
                return true; // On consid√®re que √ßa marche m√™me si on ne peut pas v√©rifier
                
            } catch (error) {
                console.error('Toutes les m√©thodes de sync ont √©chou√©:', error);
                updateBackupStatus('‚ùå Toutes les m√©thodes de sync √©chou√©es');
                return false;
            }
        }
        
        // SUPPRIMER compl√®tement les anciennes fonctions probl√©matiques
        async function sendBatchToWebhook(batch) {
            console.log('‚ö†Ô∏è Ancienne fonction sendBatchToWebhook appel√©e - redirection');
            return await sendToWebhookNoCORS({ records: batch });
        }
        
        // Simplifier intelligentSync
        async function intelligentSync() {
            const current_hash = generateDataHash();
            
            // Ne synchroniser que si les donn√©es ont chang√©
            if (current_hash === last_sync_hash && records.length > 0) {
                return; // Pas de changements
            }
            
            last_sync_hash = current_hash;
            console.log('=== INTELLIGENT SYNC D√âCLENCH√âE ===');
            
            // Utiliser directement la nouvelle fonction de sync
            const webhook_success = await syncViaWebhook();
            
            if (!webhook_success) {
                console.log('Webhook √©chou√©, activation du fallback');
                await triggerFailoverMethods();
            }
        }
        
        // M√©thodes de secours automatiques
        async function triggerFailoverMethods() {
            // 1. Export automatique de fichier
            if (!failover_methods.file_sync) {
                exporterSauvegardeAuto();
                failover_methods.file_sync = true;
                updateBackupStatus('üíæ Fichier de secours cr√©√© automatiquement');
            }
            
            // 2. Pr√©parer CSV pour copier-coller facile
            if (!failover_methods.manual_csv) {
                await exporterCSVPourSheets();
                failover_methods.manual_csv = true;
                updateBackupStatus('üìã CSV de secours pr√©par√© dans le presse-papiers');
            }
        }
        
        // Synchronisation avec d√©tection intelligente de conflit
        let last_sync_hash = '';
        
        function generateDataHash() {
            // Cr√©er un hash simple des donn√©es pour d√©tecter les changements
            const data_string = records.map(r => `${r.id}-${r.timestamp}`).join('|');
            return btoa(data_string).substring(0, 16);
        }
        
        async function intelligentSync() {
            const current_hash = generateDataHash();
            
            // Ne synchroniser que si les donn√©es ont chang√©
            if (current_hash === last_sync_hash && records.length > 0) {
                return; // Pas de changements
            }
            
            last_sync_hash = current_hash;
            
            // Essayer webhook d'abord, puis basculer sur les alternatives
            const webhook_success = await syncViaWebhook();
            
            if (!webhook_success) {
                // Basculement automatique sur les m√©thodes de secours
                updateBackupStatus('üîÑ Basculement automatique sur m√©thodes de secours...');
            }
        }
        
        // Export CSV automatique pour copier-coller dans Google Sheets
        function exporterCSVPourSheets() {
            if (records.length === 0) {
                showAlert('Aucune donn√©e √† exporter', 'warning', 2000);
                return;
            }
            
            // Cr√©er le CSV avec en-t√™tes
            const headers = 'Timestamp,N¬∞ Dossard,Type,Heure';
            const csvContent = records
                .sort((a, b) => a.timestamp - b.timestamp)
                .map(record => {
                    const timestamp = new Date(record.timestamp).toISOString();
                    return `${timestamp},${record.dossard},${record.type},${record.heure}`;
                })
                .join('\n');
            
            const fullCSV = headers + '\n' + csvContent;
            
            // Copier dans le presse-papiers
            navigator.clipboard.writeText(fullCSV).then(() => {
                showAlert('‚úÖ CSV copi√© ! Collez-le dans votre Google Sheet (Ctrl+V)', 'success', 4000);
            }).catch(() => {
                // Fallback : t√©l√©charger le fichier
                downloadCSV(fullCSV);
            });
        }
        
        function downloadCSV(csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `aquathlon_${new Date().toLocaleDateString('fr-FR').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('üìÅ Fichier CSV t√©l√©charg√© !', 'success', 2000);
        }
        
        // Import depuis CSV (pour synchronisation manuelle)
        function importerCSV(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return false;
                
                const headers = lines[0].split(',');
                const newRecords = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= 4) {
                        newRecords.push({
                            id: Date.now() + i,
                            dossard: values[1],
                            type: values[2],
                            heure: values[3],
                            timestamp: new Date(values[0]).getTime()
                        });
                    }
                }
                
                if (newRecords.length > 0) {
                    // Fusionner avec les records existants (√©viter les doublons)
                    const existingIds = new Set(records.map(r => `${r.dossard}-${r.type}-${r.heure}`));
                    const uniqueNewRecords = newRecords.filter(r => 
                        !existingIds.has(`${r.dossard}-${r.type}-${r.heure}`)
                    );
                    
                    records = [...records, ...uniqueNewRecords];
                    updateAllTables();
                    triggerAutoSave();
                    
                    showAlert(`‚úÖ ${uniqueNewRecords.length} nouveaux enregistrements import√©s`, 'success', 3000);
                    return true;
                }
            } catch (error) {
                console.error('Erreur import CSV:', error);
                showAlert('‚ùå Erreur lors de l\'import CSV', 'warning', 2000);
            }
            return false;
        }
        
        // === EXPORT AUTOMATIQUE DE FICHIERS ===
        
        // T√©l√©chargement automatique de sauvegarde
        function exporterSauvegardeAuto() {
            if (records.length === 0) return;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const data = {
                exportTime: new Date().toISOString(),
                records: records,
                totalRecords: records.length
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], 
                                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `aquathlon_backup_${timestamp}.json`;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // === INTERFACE DE CONFIGURATION ===
        
        function updateBackupStatus(message) {
            const statusElement = document.getElementById('backup-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'backup-status ' + 
                    (message.includes('‚ùå') ? 'error' : 
                     message.includes('‚òÅÔ∏è') ? 'cloud' : 'success');
            }
        }

        // Mise √† jour de l'heure en temps r√©el
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR');
            document.getElementById('startTime').textContent = timeString;
            document.getElementById('finishTime').textContent = timeString;
        }

        // Gestion des onglets
        let currentTab = 'start';
        
        function switchTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Focus automatique sur le bon champ
            setTimeout(() => {
                if (tabName === 'start') {
                    document.getElementById('startDossard').focus();
                } else if (tabName === 'finish') {
                    document.getElementById('finishDossard').focus();
                }
            }, 100);
        }

        // D√©marrer la mise √† jour du temps
        setInterval(updateTime, 1000);
        updateTime();

        // Fonction pour afficher les alertes
        function showAlert(message, type = 'success', duration = 1500) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, duration);
        }

        // Enregistrer un d√©part
        function enregistrerDepart() {
            const dossard = document.getElementById('startDossard').value;
            const now = new Date();
            const temps = now.toLocaleTimeString('fr-FR');
            
            records.push({
                id: Date.now(),
                dossard: dossard || '√Ä saisir',
                type: 'D√©part',
                heure: temps,
                timestamp: now.getTime()
            });
            
            updateAllTables();
            triggerAutoSave();
            document.getElementById('startDossard').value = '';
            document.getElementById('startDossard').focus();
            showAlert(`D√©part enregistr√© : ${dossard || 'dossard √† saisir'} √† ${temps}`, 'success', 1200);
        }

        // Enregistrer une arriv√©e
        function enregistrerArrivee() {
            const dossard = document.getElementById('finishDossard').value;
            const tempsManuel = document.getElementById('tempsManuel').value;
            
            let temps, timestamp;
            if (tempsManuel && /^\d{2}:\d{2}:\d{2}$/.test(tempsManuel)) {
                temps = tempsManuel;
                const [h, m, s] = tempsManuel.split(':').map(Number);
                const date = new Date();
                date.setHours(h, m, s, 0);
                timestamp = date.getTime();
            } else {
                const now = new Date();
                temps = now.toLocaleTimeString('fr-FR');
                timestamp = now.getTime();
            }
            
            records.push({
                id: Date.now(),
                dossard: dossard || '√Ä saisir',
                type: 'Arriv√©e',
                heure: temps,
                timestamp: timestamp
            });
            
            updateAllTables();
            triggerAutoSave();
            document.getElementById('finishDossard').value = '';
            document.getElementById('tempsManuel').value = '';
            document.getElementById('finishDossard').focus();
            showAlert(`Arriv√©e enregistr√©e : ${dossard || 'dossard √† saisir'} √† ${temps}`, 'success', 800);
        }

        // D√©clencher la sauvegarde automatique
        function triggerAutoSave() {
            if (autoSaveEnabled) {
                sauvegardeLocale();
                
                // Synchronisation intelligente avec failover
                intelligentSync();
            }
        }

        // Pr√©parer le prochain d√©part (+30s)
        function preparerProchainDepart() {
            const now = new Date();
            prochainDepartPrevu = new Date(now.getTime() + 30000); // +30 secondes
            const nextStartInfo = document.getElementById('nextStartInfo');
            const nextStartTime = document.getElementById('nextStartTime');
            
            nextStartTime.textContent = prochainDepartPrevu.toLocaleTimeString('fr-FR');
            nextStartInfo.style.display = 'block';
            
            showAlert(`Prochain d√©part pr√©vu √† ${prochainDepartPrevu.toLocaleTimeString('fr-FR')}`);
        }

        // Mettre √† jour tous les tableaux
        function updateAllTables() {
            updateRecordsTable();
            updateStartRecordsTable();
            updateFinishRecordsTable();
        }

        // Mettre √† jour le mini tableau des d√©parts
        function updateStartRecordsTable() {
            const tbody = document.getElementById('startRecordsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const startRecords = records
                .filter(record => record.type === 'D√©part')
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10); // 10 derniers d√©parts
            
            startRecords.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.dossard}</td>
                    <td>${record.heure}</td>
                    <td>
                        <button class="btn edit-btn" onclick="modifierRecord(${record.id})">‚úèÔ∏è</button>
                        <button class="btn delete-btn" onclick="supprimerRecord(${record.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        // Mettre √† jour le mini tableau des arriv√©es
        function updateFinishRecordsTable() {
            const tbody = document.getElementById('finishRecordsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const finishRecords = records
                .filter(record => record.type === 'Arriv√©e')
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10); // 10 derni√®res arriv√©es
            
            finishRecords.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.dossard}</td>
                    <td>${record.heure}</td>
                    <td>
                        <button class="btn edit-btn" onclick="modifierRecord(${record.id})">‚úèÔ∏è</button>
                        <button class="btn delete-btn" onclick="supprimerRecord(${record.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }
        // Mettre √† jour la table compl√®te des enregistrements (onglet Records)
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Trier par timestamp d√©croissant (plus r√©cent en premier)
            const sortedRecords = records.sort((a, b) => b.timestamp - a.timestamp);
            
            sortedRecords.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.dossard}</td>
                    <td><span class="status ${record.type === 'D√©part' ? 'status-depart' : 'status-arrivee'}">${record.type}</span></td>
                    <td>${record.heure}</td>
                    <td>
                        <button class="btn edit-btn" onclick="modifierRecord(${record.id})">‚úèÔ∏è</button>
                        <button class="btn delete-btn" onclick="supprimerRecord(${record.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        // Modifier un enregistrement
        function modifierRecord(id) {
            const record = records.find(r => r.id === id);
            if (record) {
                const nouveauDossard = prompt('Nouveau num√©ro de dossard:', record.dossard);
                const nouvelleHeure = prompt('Nouvelle heure (HH:MM:SS):', record.heure);
                
                if (nouveauDossard !== null) record.dossard = nouveauDossard;
                if (nouvelleHeure !== null && /^\d{2}:\d{2}:\d{2}$/.test(nouvelleHeure)) {
                    record.heure = nouvelleHeure;
                }
                
                updateAllTables();
                triggerAutoSave();
                showAlert('Enregistrement modifi√©', 'success', 1000);
            }
        }

        // Supprimer un enregistrement
        function supprimerRecord(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet enregistrement ?')) {
                records = records.filter(r => r.id !== id);
                updateAllTables();
                triggerAutoSave();
                showAlert('Enregistrement supprim√©', 'success', 1000);
            }
        }

        // Exporter en CSV
        function exporterCSV() {
            if (records.length === 0) {
                showAlert('Aucune donn√©e √† exporter', 'warning');
                return;
            }
            
            const headers = 'N¬∞ Dossard,Type,Heure\n';
            const csvContent = records
                .sort((a, b) => a.timestamp - b.timestamp)
                .map(record => `${record.dossard},${record.type},${record.heure}`)
                .join('\n');
            
            const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `aquathlon_chronos_${new Date().toLocaleDateString('fr-FR').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Export CSV t√©l√©charg√© !');
        }

        // Vider toutes les donn√©es
        function viderDonnees() {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer tous les enregistrements ?')) {
                records = [];
                updateAllTables();
                triggerAutoSave();
                showAlert('Toutes les donn√©es ont √©t√© supprim√©es', 'success', 1500);
            }
        }

        // === FONCTIONS DE CONFIGURATION ===
        
        function configurerWebhook() {
            webhook_url = document.getElementById('webhook-url').value;
            if (webhook_url) {
                sync_enabled = true;
                updateBackupStatus('üõ°Ô∏è Syst√®me hybride activ√© avec triple s√©curit√©');
                
                // R√©initialiser les flags de failover
                failover_methods = {
                    webhook: false,
                    file_sync: false,
                    manual_csv: false
                };
                
                // D√©marrer la synchronisation intelligente
                if (!window.intelligentSyncInterval) {
                    window.intelligentSyncInterval = setInterval(intelligentSync, 15000);
                }
            } else {
                sync_enabled = false;
            }
        }
        
        function configurerWebhookLegacy() {
            webhook_url = document.getElementById('webhook-url-legacy').value;
            configurerWebhook(); // R√©utiliser la m√™me logique
        }
        
        function creerAppsScript() {
            const url = 'https://script.google.com';
            window.open(url, '_blank');
            showAlert('Apps Script ouvert. Attention aux quotas : 20K requ√™tes/jour maximum !', 'success', 4000);
        }

        // Fonctions pour r√©soudre le probl√®me CORS
        function downloadHTMLFile() {
            // Cr√©er le contenu HTML complet
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = 'aquathlon-chrono.html';
            a.click();
            
            URL.revokeObjectURL(url);
            showAlert('üì• Fichier HTML t√©l√©charg√© ! Uploadez-le sur un h√©bergeur web.', 'success', 4000);
        }
        
        function openCorsInstructions() {
            const instructions = `
üö® PROBL√àME CORS D√âTECT√â

Le fichier HTML ne peut pas √™tre ouvert directement (file://)
Il doit √™tre servi par un serveur web.

üìã SOLUTIONS :

1. üåê NETLIFY DROP (Plus simple)
   - Allez sur: https://netlify.app/drop
   - Glissez le fichier HTML t√©l√©charg√©
   - Utilisez l'URL g√©n√©r√©e

2. üñ•Ô∏è SERVEUR LOCAL
   - Python: python -m http.server 8000
   - Node.js: npx serve .
   - Puis: http://localhost:8000

3. üì± GITHUB PAGES
   - Cr√©ez un repo GitHub
   - Uploadez comme index.html
   - Activez Pages dans Settings

Une fois h√©berg√©, le webhook Apps Script fonctionnera !
            `;
            
            if (confirm(instructions + '\n\nOuvrir Netlify Drop maintenant ?')) {
                window.open('https://netlify.app/drop', '_blank');
            }
        }
        
        // V√©rifier le statut de connexion et la plateforme
        function checkConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const indicatorEl = document.getElementById('connection-indicator');
            const detailsEl = document.getElementById('connection-details');
            
            if (navigator.onLine) {
                statusEl.className = 'connection-status online';
                indicatorEl.textContent = 'üåê En ligne';
                
                // D√©tecter la plateforme d'h√©bergement
                const hostname = window.location.hostname;
                if (hostname.includes('github.io')) {
                    detailsEl.textContent = '‚úÖ H√©berg√© sur GitHub Pages - Webhook disponible';
                } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    detailsEl.textContent = 'üñ•Ô∏è Serveur local - Webhook disponible';
                } else if (hostname.includes('netlify')) {
                    detailsEl.textContent = '‚úÖ H√©berg√© sur Netlify - Webhook disponible';
                } else if (hostname) {
                    detailsEl.textContent = `‚úÖ H√©berg√© sur ${hostname} - Webhook disponible`;
                } else {
                    detailsEl.textContent = '‚ö†Ô∏è H√©bergement d√©tect√© - Testez le webhook';
                }
            } else {
                statusEl.className = 'connection-status offline';
                indicatorEl.textContent = 'üì° Hors ligne';
                detailsEl.textContent = '‚ö†Ô∏è Pas de connexion - Seule la sauvegarde locale fonctionne';
            }
        }
        
        // D√©tecter si on est en file:// et afficher l'avertissement
        function detectCorsIssue() {
            if (window.location.protocol === 'file:') {
                const statusEl = document.getElementById('connection-status');
                const indicatorEl = document.getElementById('connection-indicator');
                const detailsEl = document.getElementById('connection-details');
                
                statusEl.className = 'connection-status offline';
                indicatorEl.textContent = '‚ùå Fichier local';
                detailsEl.textContent = '‚ö†Ô∏è H√©bergez sur GitHub Pages ou serveur web pour utiliser les webhooks';
                
                updateBackupStatus('‚ö†Ô∏è CORS: Fichier doit √™tre h√©berg√© sur un serveur web');
                
                // Afficher un avertissement visible
                setTimeout(() => {
                    if (records.length === 0) {
                        showAlert('‚ö†Ô∏è Pour les webhooks, utilisez GitHub Pages ou un serveur web !', 'warning', 6000);
                    }
                }, 3000);
            } else {
                checkConnectionStatus();
            }
        }
        
        function testerWebhook() {
            if (!webhook_url) {
                showAlert('Veuillez d\'abord configurer l\'URL du webhook', 'warning', 3000);
                return;
            }
            
            updateBackupStatus('üîÑ Test webhook...');
            syncViaWebhook();
        }
        
        // Gestion de l'import de fichiers
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    importerCSV(content);
                } else if (file.name.endsWith('.json')) {
                    try {
                        const jsonData = JSON.parse(content);
                        if (jsonData.records && Array.isArray(jsonData.records)) {
                            records = [...records, ...jsonData.records];
                            updateAllTables();
                            triggerAutoSave();
                            showAlert(`‚úÖ ${jsonData.records.length} enregistrements import√©s depuis JSON`, 'success', 3000);
                        }
                    } catch (error) {
                        showAlert('‚ùå Erreur lors de l\'import JSON', 'warning', 2000);
                    }
                }
            };
            
            reader.readAsText(file);
            // R√©initialiser l'input pour permettre de s√©lectionner le m√™me fichier
            event.target.value = '';
        }

        // === INITIALISATION ET TIMERS ===
        
        // D√©marrer les sauvegardes automatiques
        function startAutoBackup() {
            // Sauvegarde locale toutes les 5 secondes si des donn√©es
            setInterval(() => {
                if (records.length > 0 && autoSaveEnabled) {
                    sauvegardeLocale();
                }
            }, BACKUP_CONFIG.localInterval);
            
            // Tentative de restauration au d√©marrage
            setTimeout(() => {
                if (records.length === 0) {
                    restaurerSauvegarde();
                }
            }, 1000);
        }

        // Gestion des touches du clavier
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                
                // Onglet d√©parts
                if (currentTab === 'start') {
                    if (activeElement.id === 'startDossard' || activeElement.tagName !== 'INPUT') {
                        event.preventDefault();
                        enregistrerDepart();
                    }
                }
                // Onglet arriv√©es
                else if (currentTab === 'finish') {
                    if (activeElement.id === 'finishDossard' || activeElement.id === 'tempsManuel' || activeElement.tagName !== 'INPUT') {
                        event.preventDefault();
                        enregistrerArrivee();
                    }
                }
            }
        });

        // Focus automatique au chargement et changement d'onglet
        window.onload = function() {
            document.getElementById('startDossard').focus();
            startAutoBackup();
            detectCorsIssue();
            
            // Restaurer automatiquement si des donn√©es existent
            if (records.length === 0) {
                setTimeout(restaurerSauvegarde, 500);
            }
        };
    </script>
</body>
</html>